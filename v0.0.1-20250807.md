# CrewAI平台智能聊天界面 v0.0.1-20250807 迭代计划

## 🎯 迭代目标
实现CrewAI平台的基础智能聊天界面，支持用户与Agent的实时对话交互，为后续的多Agent协作功能奠定基础。

## 📋 本迭代功能列表

### 🗃️ 后端开发
- [x] **数据库模型设计** - 创建聊天相关的数据库表结构
- [ ] **基础API接口** - 实现会话和消息管理的核心API
- [ ] **简单Agent调用** - 实现单Agent响应用户消息的基础功能
- [ ] **WebSocket通信** - 建立实时消息推送机制

### 🎨 前端开发  
- [ ] **聊天界面布局** - 创建基础的聊天界面结构
- [ ] **消息列表组件** - 实现消息展示和交互功能
- [ ] **输入组件** - 创建消息输入和发送功能
- [ ] **Agent选择面板** - 实现简单的Agent选择界面

### 🔧 基础功能
- [ ] **会话管理** - 创建、切换、删除聊天会话
- [ ] **消息发送** - 用户消息发送和Agent响应
- [ ] **实时更新** - WebSocket实时消息推送
- [ ] **错误处理** - 基础的错误提示和处理机制

## 📊 数据库表结构

### 1. 聊天会话表 (chat_conversation)
```sql
CREATE TABLE chat_conversation (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL DEFAULT '新会话',
    description TEXT,
    user_id BIGINT NOT NULL REFERENCES auth_user(id) ON DELETE CASCADE,
    
    -- 基础配置
    agent_selection_mode VARCHAR(32) DEFAULT 'manual' CHECK (agent_selection_mode IN ('auto', 'manual', 'smart')),
    primary_agent_id BIGINT REFERENCES crewai_agent(id) ON DELETE SET NULL,
    
    -- 统计信息
    total_messages INTEGER DEFAULT 0,
    total_agent_calls INTEGER DEFAULT 0,
    
    -- 状态管理
    status VARCHAR(32) DEFAULT 'active' CHECK (status IN ('active', 'archived')),
    last_activity_at TIMESTAMP WITH TIME ZONE,
    
    -- 时间戳
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 2. 聊天消息表 (chat_message)
```sql
CREATE TABLE chat_message (
    id BIGSERIAL PRIMARY KEY,
    conversation_id BIGINT NOT NULL REFERENCES chat_conversation(id) ON DELETE CASCADE,
    
    -- 消息基础信息
    role VARCHAR(32) NOT NULL CHECK (role IN ('user', 'assistant', 'system')),
    content TEXT NOT NULL,
    
    -- Agent信息（助手消息）
    agent_id BIGINT REFERENCES crewai_agent(id) ON DELETE SET NULL,
    agent_name VARCHAR(128),
    
    -- 消息状态
    status VARCHAR(32) DEFAULT 'sent' CHECK (status IN ('pending', 'sent', 'processing', 'completed', 'failed')),
    error_message TEXT,
    
    -- 时间戳
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 3. Agent任务表 (chat_agent_task)
```sql
CREATE TABLE chat_agent_task (
    id BIGSERIAL PRIMARY KEY,
    conversation_id BIGINT NOT NULL REFERENCES chat_conversation(id) ON DELETE CASCADE,
    message_id BIGINT NOT NULL REFERENCES chat_message(id) ON DELETE CASCADE,
    
    -- 任务信息
    task_description TEXT NOT NULL,
    agent_id BIGINT NOT NULL REFERENCES crewai_agent(id) ON DELETE CASCADE,
    agent_name VARCHAR(128) NOT NULL,
    
    -- 执行状态
    status VARCHAR(32) DEFAULT 'pending' CHECK (status IN ('pending', 'running', 'completed', 'failed')),
    start_time TIMESTAMP WITH TIME ZONE,
    end_time TIMESTAMP WITH TIME ZONE,
    execution_time_ms INTEGER DEFAULT 0,
    
    -- 结果
    result TEXT,
    error_details TEXT,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## 🏗️ 技术架构

### 后端架构
```
backend/crewaiplatform/
├── models/
│   ├── chat_conversation.py    # 聊天会话模型
│   ├── chat_message.py        # 聊天消息模型
│   └── chat_agent_task.py     # Agent任务模型
├── serializers/
│   ├── chat_serializers.py    # 聊天相关序列化器
├── views/
│   ├── chat_views.py          # 聊天API视图
├── services/
│   ├── chat_service.py        # 聊天业务逻辑服务
│   └── agent_service.py       # Agent调用服务
├── consumers.py               # WebSocket消费者
└── routing.py                 # WebSocket路由
```

### 前端架构
```
frontend/src/
├── views/
│   └── ChatInterface.vue      # 主聊天界面
├── components/
│   ├── ChatSidebar.vue       # 左侧会话列表
│   ├── MessageList.vue       # 消息列表
│   ├── MessageInput.vue      # 输入组件
│   └── AgentSelector.vue     # Agent选择器
├── services/
│   └── chatApi.js            # 聊天API服务
└── store/
    └── chat.js               # 聊天状态管理
```

## 🎯 核心功能实现

### 1. 基础聊天流程
1. 用户创建新会话
2. 选择要使用的Agent
3. 发送消息给Agent
4. Agent处理并返回响应
5. 实时显示对话历史

### 2. Agent响应机制
- 单Agent处理用户消息
- 基础的CrewAI Agent调用
- 简单的错误处理和重试
- 响应时间统计

### 3. 实时通信
- WebSocket建立连接
- 消息实时推送
- 连接状态管理
- 断线重连机制

## ✅ 验收标准

### 功能验收
- [ ] 能够创建和管理聊天会话
- [ ] 能够选择Agent并发送消息
- [ ] Agent能够正确响应用户消息
- [ ] 消息能够实时显示和更新
- [ ] 基础的错误处理正常工作

### 性能验收
- [ ] 消息发送响应时间 < 200ms
- [ ] Agent响应时间 < 30s
- [ ] WebSocket连接稳定
- [ ] 界面操作流畅无卡顿

### 用户体验验收
- [ ] 界面布局清晰直观
- [ ] 操作流程符合用户习惯
- [ ] 错误提示友好明确
- [ ] 支持基础的键盘快捷键

## 🚀 部署和测试

### 开发环境准备
1. 确保PostgreSQL数据库运行正常
2. 执行数据库迁移创建新表
3. 启动Django开发服务器
4. 启动Vue前端开发服务器
5. 配置WebSocket支持

### 测试用例
1. **会话管理测试**
   - 创建新会话
   - 切换会话
   - 删除会话

2. **消息功能测试**
   - 发送文本消息
   - Agent响应测试
   - 消息历史查看

3. **实时通信测试**
   - WebSocket连接测试
   - 消息实时推送测试
   - 断线重连测试

## 📝 开发注意事项

### 安全考虑
- 用户只能访问自己的会话
- Agent调用需要适当的权限验证
- WebSocket连接需要认证
- 输入内容需要基础的安全过滤

### 性能优化
- 消息列表分页加载
- Agent响应异步处理
- WebSocket连接池管理
- 数据库查询优化

### 错误处理
- Agent调用失败的优雅降级
- 网络连接异常的重试机制
- 用户输入验证和错误提示
- 系统异常的日志记录

## 🔄 后续迭代规划

### v0.0.2 (预计2025-08-14)
- 多Agent协作功能
- 智能Agent选择算法
- 文件上传和处理
- 更丰富的消息类型

### v0.0.3 (预计2025-08-21)
- Agent协作模式实现
- 任务分解和调度
- 性能监控和优化
- 用户偏好设置

---

**迭代负责人**: 开发团队  
**完成时间**: 2025-08-07  
**版本标签**: v0.0.1-20250807